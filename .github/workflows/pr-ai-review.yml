name: AI PR Review

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: ai-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    if: ${{ !github.event.pull_request.draft && !contains(github.event.pull_request.labels.*.name, 'skip-ai-review') }}
    runs-on: ubuntu-latest
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­è¾¼
        id: prompts
        run: |
          {
            echo 'system<<EOF'
            cat .github/ai-prompts/system.md
            echo 'EOF'
            echo 'pr_review<<EOF'
            cat .github/ai-prompts/pr-review.md
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: ãƒ¬ãƒ“ãƒ¥ãƒ¼å…¥åŠ›ç”Ÿæˆ
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number: pr.number,
              per_page: 100,
            });
            const fileSummaries = files.map((file) => {
              const delta = `+${file.additions}/-${file.deletions}`;
              return `- ${file.filename} (${file.status}, ${delta})`;
            });
            const filesPreview = fileSummaries.slice(0, 40).join('\n');
            const omittedCount = Math.max(files.length - 40, 0);
            const diffResponse = await github.request('GET /repos/{owner}/{repo}/pulls/{pull_number}', {
              owner,
              repo,
              pull_number: pr.number,
              mediaType: { format: 'diff' },
            });
            const rawDiff = diffResponse.data || '';
            const diffLimit = 12000;
            const diffExcerpt = rawDiff.length > diffLimit
              ? `${rawDiff.slice(0, diffLimit)}\n...diff truncated...`
              : rawDiff;
            const meta = [
              `PR #${pr.number}: ${pr.title}`,
              `Author: ${pr.user.login}`,
              `Base: ${pr.base.ref} -> Head: ${pr.head.ref}`,
              `URL: ${pr.html_url}`,
              `Commits: ${pr.commits}, Files: ${pr.changed_files}, Additions/Deletions: +${pr.additions}/-${pr.deletions}`,
              `Labels: ${(pr.labels || []).map((label) => label.name).join(', ') || 'ãªã—'}`,
            ].join('\n');
            const summary = [
              meta,
              '',
              'Changed files:',
              filesPreview || '- (å·®åˆ†æƒ…å ±ãªã—)',
            ];
            if (omittedCount > 0) {
              summary.push(`...and ${omittedCount} more files omitted from the list above.`);
            }
            summary.push('', 'Diff excerpt:', diffExcerpt || '(diff unavailable)');
            const reviewInput = summary.join('\n');
            core.setOutput('input', reviewInput);

      - name: AIãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
        id: ai_review
        uses: actions/ai-interface@v1
        with:
          model: github.gpt-4o-mini
          system: ${{ steps.prompts.outputs.system }}
          instructions: ${{ steps.prompts.outputs.pr_review }}
          input: ${{ steps.context.outputs.input }}

      - name: ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
        if: ${{ steps.ai_review.outputs.response != '' }}
        uses: actions/github-script@v7
        env:
          AI_RESPONSE: ${{ steps.ai_review.outputs.response }}
        with:
          script: |
            const existingComments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              per_page: 100,
            });
            const marker = '<!-- ai-pr-review -->';
            const body = `${marker}\n### ğŸ¤– AI Review\n\n${process.env.AI_RESPONSE}`;
            const previous = existingComments.find((comment) => comment.body && comment.body.includes(marker));
            if (previous) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: previous.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body,
              });
            }
